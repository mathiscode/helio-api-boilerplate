!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Helio=t():e.Helio=t()}(global,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=14)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("express")},function(e,t){},function(e,t){e.exports=require("express-jwt")},function(e,t){e.exports=require("figlet")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("winston-console-format")},function(e,t){e.exports=require("express-rate-limit")},function(e,t){e.exports=require("winston-mongodb")},function(e,t){e.exports=require("cors")},function(e){e.exports={name:"helio-api-boilerplate",version:"0.8.0",description:"Extensible backend boilerplate utilizing Express.js, Mongoose, JWT, and User registration/authentication",author:"J.R. Mathis (https://github.com/mathiscode)",license:"MIT",homepage:"https://github.com/mathiscode/helio-api-boilerplate#readme",main:"dist/index.js",bin:{helio:"./dist/bin/helio"},keywords:["nodejs","express","jwt","mongoose","mongodb","boilerplate","api-server"],scripts:{dev:'concurrently "webpack --watch" "npm run server"',start:"npm run server:prod",server:"cross-env NODE_ENVIRONMENT=development nodemon --exec babel-node  --require node_modules/dotenv/config src/bin/helio","server:prod":"cross-env NODE_ENVIRONMENT=production node dist/bin/helio",webpack:"webpack",build:"cross-env NODE_ENV=production npm-run-all webpack build:mods","build:mods":"babel src/mods --out-dir dist/mods","version:patch":"npm version patch","version:minor":"npm version minor","version:major":"npm version major",push:"git push && npm publish",test:"eslint src && cross-env NODE_ENV=testing PORT=0 mocha --require @babel/register --require dotenv/config --exit","test:mods":"npm-run-all test:mods:users test:mods:blog","test:mods:users":"newman run -e test/postman/postman_environment.json test/postman/collections/UsersMod.json","test:mods:blog":"newman run -e test/postman/postman_environment.json test/postman/collections/BlogMod.json","test:mods:staging":"npm-run-all test:mods:staging:users test:mods:staging:blog","test:mods:staging:users":"newman run -e test/postman/postman_environment_staging.json test/postman/collections/UsersMod.json","test:mods:staging:blog":"newman run -e test/postman/postman_environment_staging.json test/postman/collections/BlogMod.json","test:mods:prod":"npm-run-all test:mods:prod:users test:mods:prod:blog","test:mods:prod:users":"newman run -e test/postman/postman_environment_prod.json test/postman/collections/UsersMod.json","test:mods:prod:blog":"newman run -e test/postman/postman_environment_prod.json test/postman/collections/BlogMod.json",commit:"commit-wizard","snyk-protect":"snyk protect","prepublish-disabled":"npm run snyk-protect"},repository:{type:"git",url:"git+https://github.com/mathiscode/helio-api-boilerplate.git"},bugs:{url:"https://github.com/mathiscode/helio-api-boilerplate/issues"},engines:{node:">=11.6.0"},standard:{ignore:["/dist"]},dependencies:{"@babel/polyfill":"^7.4.4",bcryptjs:"^2.4.3","body-parser":"^1.19.0",commander:"^2.20.0","cross-env":"^5.2.0",dotenv:"^8.0.0",express:"^4.16.4","express-jwt":"^5.3.1","express-rate-limit":"^4.0.1",figlet:"^1.2.4","helio-app-react-template":"file:../helio-apps/helio-app-react-template","helio-app-authentication":"file:../helio-apps/helio-app-authentication","helio-mod-jokes":"^1.0.0","helio-mod-users":"^1.1.1",jsonwebtoken:"^8.5.1",mongoose:"^5.5.4","npm-run-all":"^4.1.5",snyk:"^1.231.0",uuid:"^3.3.2",winston:"^3.2.1","winston-console-format":"^1.0.5","winston-mongodb":"^5.0.0"},devDependencies:{"@babel/cli":"^7.4.4","@babel/core":"^7.4.4","@babel/node":"^7.2.2","@babel/preset-env":"^7.4.4","@babel/register":"^7.4.4","babel-loader":"^8.0.6",chai:"^4.2.0","chai-http":"^4.3.0","clean-webpack-plugin":"^2.0.2",concurrently:"^4.1.2","copy-webpack-plugin":"^5.0.3",cors:"^2.8.5","create-file-webpack":"^1.0.2",eslint:"^5.16.0","eslint-config-standard":"^12.0.0","eslint-plugin-import":"^2.17.2","eslint-plugin-node":"^9.1.0","eslint-plugin-promise":"^4.1.1","eslint-plugin-standard":"^4.0.0",mocha:"^6.1.4",newman:"^4.5.0",nodemon:"^1.18.11","pre-git":"^3.17.1",standard:"^12.0.1",webpack:"^4.32.2","webpack-cli":"^3.3.2","webpack-node-externals":"^1.7.2"},resolutions:{"set-value":"^2.0.1"},release:{analyzeCommits:"simple-commit-message"},config:{"pre-git":{"pre-commit":["npm run build","npm test","git add ."]}},snyk:!0}},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("@babel/polyfill")},function(e,t,o){"use strict";o.r(t);o(13);var n=o(5),r=o.n(n),s=o(2),i=o.n(s),a=o(6),l=o.n(a),u=o(0),p=o.n(u),c=o(4),d=o.n(c),m=o(1),f=o.n(m),g=o(7),h=o(8),b=o.n(h),v=o(9),y=o(10),O=o.n(y),w=o(11),E=o(3),_=o(12),x=o.n(_),j=p.a.Schema({id:{type:String,index:!0,unique:!0},username:{type:String,index:!0,unique:!0},email:{type:String,index:!0,unique:!0},password:String,roles:[{type:String}],flags:{confirmed:{type:Boolean,default:!1}},profile:{name:String},settings:{},clientSettings:{},serverSettings:{}},{timestamps:!0});j.methods.validPassword=function(e){return x.a.compareSync(e,this.password)};var S=p.a.model("User",j),T=p.a.Schema({id:{type:String,index:!0,unique:!0}},{timestamps:!0}),L=p.a.model("BlogPost",T),I=p.a.Schema({token:{type:String,required:!0,unique:!0}},{timestamps:!0});I.index({createdAt:1},{expires:process.env.JWT_TIMEOUT||"1h"});var R=p.a.model("TokenWhitelist",I);function M(e,t,o,n,r,s,i){try{var a=e[s](i),l=a.value}catch(e){return void o(e)}a.done?t(l):Promise.resolve(l).then(n,r)}function k(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function P(e){return(P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function U(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function D(e){return function(e){if(Array.isArray(e)){for(var t=0,o=new Array(e.length);t<e.length;t++)o[t]=e[t];return o}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}o.d(t,"DefaultModels",function(){return q});var q=[{name:"User",model:S},{name:"BlogPost",model:L},{name:"TokenWhitelist",model:R}],A=["/"].concat(D(process.env.PUBLIC_PATHS?process.env.PUBLIC_PATHS.split(","):[])),B=function(){function e(t){var o=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),(t=this.options=t||{}).middleware="function"==typeof t.middleware?[t.middleware]:t.middleware,t.middleware=Array.isArray(t.middleware)?t.middleware:[],this.rootHandler=t.rootHandler||null,this.apps=t.apps,this.mods=t.mods||E.Mods,this.models=t.models||E.ModModels,this.routes=t.routes||[];var n=this.app=i()();n.set("HELIO_DB_URI",t.dbUri||process.env.DB_URI),n.set("HELIO_JWT_SECRET",t.jwtSecret||process.env.JWT_SECRET),n.set("HELIO_JWT_TIMEOUT",t.jwtTimeout||process.env.JWT_TIMEOUT||"1h"),n.set("HELIO_LOG_TO_DB",t.logToDB||"true"===process.env.LOG_TO_DB),n.set("HELIO_CONSOLE_LOG",t.consoleLog||"true"===process.env.CONSOLE_LOG),n.set("HELIO_CONSOLE_ERRORS",t.consoleErrors||"true"===process.env.CONSOLE_ERRORS),p.a.set("debug",t.mongooseDebug||!1);var s=!1;if(n.get("HELIO_DB_URI")||(s="You must pass dbUri option or have DB_URI environment variable"),n.get("HELIO_JWT_SECRET")||(s="You must pass jwtSecret option or have JWT_SECRET environment variable"),s)throw new Error(s);var a=t.logTransports||[];n.get("HELIO_LOG_TO_DB")&&a.push(new v.MongoDB({db:n.get("HELIO_DB_URI")})),a.push(new f.a.transports.Console({format:f.a.format.combine(f.a.format.colorize({all:!0}),f.a.format.padLevels(),Object(g.consoleFormat)({showMeta:!0,metaStrip:["timestamp","service"],inspectOptions:{depth:8,colors:!0,maxArrayLength:1/0,breakLength:120,compact:1/0}})),silent:!n.get("HELIO_CONSOLE_LOG")})),this.log=f.a.createLogger({level:this.options.logLevel||process.env.LOG_LEVEL||"silly",format:f.a.format.combine(f.a.format.timestamp(),f.a.format.ms(),f.a.format.errors({stack:!0}),f.a.format.splat(),f.a.format.json()),transports:a});var l=function(){o.connectDB(),o.initializeServer()};if(this.options.hideBanner)return l();r.a.text(this.options.bannerText||"Helio",{font:this.options.bannerFont||"The Edge",horizontalLayout:"default",verticalLayout:"default"},function(e,t){e&&o.log.silly("Unable to show banner:",e),e||console.log(t),l()})}var t,o,n;return t=e,(o=[{key:"connectDB",value:function(){var e=this,t=this.app.get("HELIO_DB_URI");"object"!==P(this.options.mongooseOptions)&&(this.options.mongooseOptions={}),this.options.mongooseOptions=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),n.forEach(function(t){k(e,t,o[t])})}return e}({},{useNewUrlParser:!0,useFindAndModify:!1,useCreateIndex:!0,useUnifiedTopology:!0},this.options.mongooseOptions),this.db=p.a.connect(t,this.options.mongooseOptions).then(function(o){return e.log.verbose("Mongo Database:",{connected:!0,uri:t.replace(/:\w+/g,":****")})}).catch(function(t){e.log.error("Mongoose Connection Error:",t),e.log.error("Refusing to continue without usable database. Exiting."),process.exit(1)})}},{key:"initializeServer",value:function(){var e=this;this.log.silly("Server initializing",{helio:w.version});var t=this.app,o=this.options;t.disable("x-powered-by"),t.use(l.a.json()),o.trustProxy&&t.set("trust proxy",1);var n=b()({windowMs:o.rateLimitWindow||process.env.RATE_LIMIT_WINDOW||9e5,max:o.rateLimitMaxRequestsPerWindow||process.env.RATE_LIMIT_MAX_REQUESTS_PER_WINDOW||100,skip:function(e,t){return"127.0.0.1"===e.ip||"::ffff:127.0.0.1"===e.ip||"::1"===e.ip||(o.rateLimitExemptUrls||["/jokes"]).includes(e.url)}});o.disableRateLimiter||t.use(n),t.use(function(t,o,n){return t.log=t.Log=e.log,t.db=e.db,e.log.silly("Incoming request:",{url:t.url,ip:t.ip,rate:t.rateLimit||1/0}),n()}),o.middleware.forEach(function(e){return t.use(e)}),this.apps&&this.apps.forEach(function(o){var n=i.a.Router(),r=new o(n);e.log.silly("Loading app:",{name:r.name,version:r.package.version,root:r.root}),r.corsAllowedOrigins&&r.corsAllowedOrigins.length>0&&t.use(r.root,O()({origin:function(e,t){if(!e)return t(null,!0);if(-1===r.corsAllowedOrigins.indexOf(e)){return t(new Error("The CORS policy for this site does not allow access from the specified Origin."),!1)}return t(null,!0)}})),r.static&&t.use(r.root,i.a.static(r.static)),t.use(r.root,n)}),this.mods&&this.mods.forEach(function(e){var t=new(0,e.module)(e),o=t.publicPaths||[];A=[].concat(D(A),D(o)),t=null});var r=function(){var e,t=(e=regeneratorRuntime.mark(function e(t,o,n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,R.countDocuments({token:t.headers.authorization.replace("Bearer ","")});case 2:return r=e.sent,e.abrupt("return",n(null,!r));case 4:case"end":return e.stop()}},e)}),function(){var t=this,o=arguments;return new Promise(function(n,r){var s=e.apply(t,o);function i(e){M(s,n,r,i,a,"next",e)}function a(e){M(s,n,r,i,a,"throw",e)}i(void 0)})});return function(e,o,n){return t.apply(this,arguments)}}();t.use(d()({secret:t.get("HELIO_JWT_SECRET"),credentialsRequired:!1}));var s=[];this.mods&&this.mods.forEach(function(e){var o=new(0,e.module)(e);if(o.receiveModels&&o.needModels){var n=E.ModModels.filter(function(e){return o.needModels.includes(e.name)});o.receiveModels(n)}t.use(e.path,d()({secret:t.get("HELIO_JWT_SECRET"),isRevoked:r}).unless({path:A}),o.router),s.push(o.name)}),s.length>0&&this.log.verbose("Registered Mods:",{mods:s});var a=[];this.routes.forEach(function(e){t.use(e.path,e.module),a.push(e.path)}),a.length>0&&this.log.info("Registered Core Routes:",{routes:a}),t.use(function(e,t,o){return t.status(404).json({error:"Invalid API method"})}),t.use(function(t,n,r,s){return o.consoleErrors&&"UnauthorizedError"!==t.name&&e.log.error("APP ERROR:",t),"UnauthorizedError"===t.name?r.status(401).json({error:"Invalid token"}):r.status(500).json({error:"Internal API error"})}),o.noListen||this.listen()}},{key:"listen",value:function(e){var t=this,o=this.options.port||process.env.PORT||3001,n=this.app.listen(o,function(){t.port=n.address().port,t.log.info("".concat(t.options.name||process.env.HELIO_NAME||"Helio API Server"," listening"),n.address()),"function"==typeof e&&e(n)})}}])&&U(t.prototype,o),n&&U(t,n),e}();t.default=B}])});