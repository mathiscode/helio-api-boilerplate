!function(e){var t={};function s(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,s),r.l=!0,r.exports}s.m=e,s.c=t,s.d=function(e,t,o){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(s.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(o,r,function(t){return e[t]}.bind(null,r));return o},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=12)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("express-jwt")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express-rate-limit")},function(e,t){e.exports=require("winston-mongodb")},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("helio-mod-users")},function(e,t){e.exports=require("helio-mod-jokes")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("@babel/polyfill")},function(e,t,s){"use strict";s.r(t);s(11);var o=s(1),r=s.n(o),n=s(4),i=s.n(n),a=s(0),d=s.n(a),l=s(3),u=s.n(l),c=s(2),p=s.n(c),h=s(5),m=s.n(h),g=s(6),f=s(7),b=s(8),O=s.n(b),E=s(9),S=s.n(E),_=s(10),y=s.n(_);const v=d.a.Schema({id:{type:String,index:!0,unique:!0},username:{type:String,index:!0,unique:!0},email:{type:String,index:!0,unique:!0},password:String,roles:[{type:String}],flags:{confirmed:{type:Boolean,default:!1}},profile:{name:String},settings:{},clientSettings:{},serverSettings:{}},{timestamps:!0});v.methods.validPassword=function(e){return y.a.compareSync(e,this.password)};var P=d.a.model("User",v);const M=d.a.Schema({id:{type:String,index:!0,unique:!0}},{timestamps:!0});var w=d.a.model("BlogPost",M);const x=d.a.Schema({token:{type:String,required:!0,unique:!0}},{timestamps:!0});x.index({createdAt:1},{expires:process.env.JWT_TIMEOUT||"1h"});var R=d.a.model("TokenWhitelist",x);const I=[{path:"/example",module:class{constructor(e){this.name=e.name||"Example Helio Mod";const t=this.router=r.a.Router();this.publicPaths=[e.path,new RegExp(`^${e.path}/.*`)],this.needModels=["User"],this.subSchemas={User:new d.a.Schema({myData:{field1:String,field2:{type:Number,required:!0},field3:{type:Date,default:Date.now},field4:Boolean,field5:[{type:String,default:"Field5 Data"}]}})},t.get("/",this.index.bind(this)),t.get("/add/:x/:y",this.add),t.get("/test-error",this.testError);const s=this;t.use((e,t,o,r)=>(t.Log.error(`[MOD ERROR] (${s.name}) ${e.stack}`),o.status(500).json({error:e.toString()})))}receiveModels(e){this.models={},this.subModels={},e.forEach(e=>{this.models[e.name]=e.model});for(const e in this.subSchemas){const t=this.models[e],s=this.subSchemas[e];this.subModels[e]=t.discriminator(this.name,s)}}index(e,t,s){const{user:o}=e;t.json({mod:this.name,user:o})}add(e,t,s){let{x:o,y:r}=e.params;o=parseFloat(o),r=parseFloat(r),t.json(o+r)}testError(e,t,s){s(new Error("Intentional Error"))}}},{path:"/user",module:O.a},{path:"/blog",module:class{constructor(e){this.name=e.name||"Helio Blog Mod";const t=this.router=r.a.Router();this.needModels=["BlogPost"],this.subSchemas={BlogPost:new d.a.Schema({owner:String,public:{type:Boolean,default:!0},title:{type:String,required:!0},excerpt:String,content:{type:String,required:!0}})},this.subSchemas.BlogPost.options.toJSON={transform:(e,t,s)=>(delete t._id,delete t.__v,delete t.__t,t)},t.get("/",this.getAllMyPosts.bind(this)),t.post("/",this.addPost.bind(this)),t.get("/:id",this.getPost.bind(this)),t.patch("/:id",this.updatePost.bind(this)),t.delete("/:id",this.deletePost.bind(this));const s=this;t.use((e,t,o,r)=>(t.Log.error(`[MOD ERROR] (${s.name}) ${e.stack}`),o.status(500).json({error:e.toString()})))}receiveModels(e){this.models={},this.subModels={},e.forEach(e=>{this.models[e.name]=e.model});for(const e in this.subSchemas){const t=this.models[e],s=this.subSchemas[e];this.subModels[e]=t.discriminator(this.name,s)}}async getAllMyPosts(e,t,s){try{const o=await this.subModels.BlogPost.find({owner:e.user.id}).sort({createdAt:"desc"});t.json(o)}catch(e){s(e)}}async addPost(e,t,s){try{const o=new this.subModels.BlogPost({id:Object(f.v4)(),owner:e.user.id,public:e.body.public||!0,title:e.body.title||"Untitled Blog Post",excerpt:e.body.excerpt?e.body.excerpt.substring(0,256):e.body.content.length>256?e.body.content.substring(0,256)+"...":null,content:e.body.content});await o.save(),t.json(o)}catch(e){s(e)}}async getPost(e,t,s){try{const o=await this.subModels.BlogPost.findOne({id:e.params.id,$or:[{owner:e.user.id},{public:!0}]});if(!o)return t.status(404).json({error:"Post not found"});t.json(o)}catch(e){s(e)}}async updatePost(e,t,s){try{const o=await this.subModels.BlogPost.findOneAndUpdate({id:e.params.id,owner:e.user.id},{...e.body},{new:!0});t.json(o)}catch(e){s(e)}}async deletePost(e,t,s){try{const o=await this.subModels.BlogPost.findOneAndRemove({id:e.params.id,owner:e.user.id});t.json(o)}catch(e){s(e)}}}},{path:"/jokes",module:S.a}],L=[{name:"User",model:P},{name:"BlogPost",model:w},{name:"TokenWhitelist",model:R}];let T=["/",...process.env.PUBLIC_PATHS?process.env.PUBLIC_PATHS.split(","):[]];t.default=class{constructor(e){e=this.options=e||{},this.mods=e.mods||I,this.models=e.models||L,this.routes=[];const t=this.app=r()();t.set("HELIO_DB_URI",e.mongoose?null:e.dbUri||process.env.DB_URI),t.set("HELIO_MONGOOSE",e.mongoose),t.set("HELIO_JWT_SECRET",e.jwtSecret||process.env.JWT_SECRET),t.set("HELIO_LOG_TO_DB",e.logToDB||"true"===process.env.LOG_TO_DB),t.set("HELIO_CONSOLE_LOG",e.consoleLog||"true"===process.env.CONSOLE_LOG),t.set("HELIO_CONSOLE_ERRORS",e.consoleErrors||"true"===process.env.CONSOLE_ERRORS),d.a.set("useNewUrlParser",!0),d.a.set("useFindAndModify",!1),d.a.set("useCreateIndex",!0);let s=!1;if(t.get("HELIO_DB_URI")||t.get("HELIO_MONGOOSE")||(s="You must pass dbUri option or have DB_URI environment variable"),t.get("HELIO_JWT_SECRET")||(s="You must pass jwtSecret option or have JWT_SECRET environment variable"),s)throw new Error(s);const o=e.logTransports||[];t.get("HELIO_LOG_TO_DB")&&o.push(new g.MongoDB({db:t.get("HELIO_DB_URI")||t.get("HELIO_MONGOOSE")})),o.push(new p.a.transports.Console({format:p.a.format.simple(),silent:"false"===process.env.CONSOLE_LOG})),this.log=p.a.createLogger({format:p.a.format.json(),transports:o}),this.initializeServer(e)}connectDB(){this.app.get("HELIO_MONGOOSE")||(this.log.info("Connecting to database..."),d.a.connect(process.env.DB_URI,e=>{if(e)throw this.log.error(e.toString()),new Error(e)}))}initializeServer(e){const t=this.app;t.disable("x-powered-by"),t.use(i.a.json());const s=m()({windowMs:process.env.RATE_LIMIT_WINDOW||9e5,max:process.env.RATE_LIMIT_MAX_REQUESTS_PER_WINDOW||100,skip:(e,t)=>"127.0.0.1"===e.ip||"::1"===e.ip});t.use(s),t.use((e,t,s)=>{e.Log=this.log,s()}),this.mods.forEach(e=>{let t=new(0,e.module)(e);const s=t.publicPaths||[];T=[...T,...s],t=null});t.use(u()({secret:process.env.JWT_SECRET,credentialsRequired:!1})),t.use(u()({secret:process.env.JWT_SECRET,isRevoked:async(e,t,s)=>{return s(null,!await R.countDocuments({token:e.headers.authorization.replace("Bearer ","")}))}}).unless({path:T})),this.mods.forEach(e=>{const s=new(0,e.module)(e);if(s.receiveModels&&s.needModels){const e=L.filter(e=>s.needModels.includes(e.name));s.receiveModels(e)}t.use(e.path,s.router),this.log.debug(`[MOD REGISTERED] ${s.name}`)}),t.get("/",(t,s)=>{s.json({name:e.name||process.env.NAME||"Helio API Server"})}),this.routes.forEach(e=>{t.use(e.path,e.module)}),t.use((e,t,s)=>{t.status(404).json({error:"Invalid API method"})}),t.use((t,s,o,r)=>(e.consoleErrors&&"UnauthorizedError"!==t.name&&this.log.error("APP ERROR:",t.stack),"UnauthorizedError"===t.name?o.status(401).json({error:"Invalid token"}):o.status(500).json({error:"Internal API error"}))),this.options.noListen||this.listen(this.options)}listen(e){this.app.listen(e.port||process.env.PORT||3001),this.log.info(`${process.env.NAME||"Helio API Server"} listening`)}}}]);