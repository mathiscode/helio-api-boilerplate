!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Helio=t():e.Helio=t()}(global,function(){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=16)}([function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("express-jwt")},function(e){e.exports={name:"helio-api-boilerplate",version:"0.7.0",description:"Extensible backend boilerplate utilizing Express.js, Mongoose, JWT, and User registration/authentication",author:"J.R. Mathis (https://github.com/mathiscode)",license:"MIT",homepage:"https://github.com/mathiscode/helio-api-boilerplate#readme",main:"dist/index.js",bin:{helio:"./dist/bin/helio"},keywords:["nodejs","express","jwt","mongoose","mongodb","boilerplate","api-server"],scripts:{dev:'concurrently "webpack --watch" "npm run server"',start:"npm run server:prod",server:"cross-env NODE_ENVIRONMENT=development nodemon --exec babel-node  --require node_modules/dotenv/config src/bin/helio","server:prod":"cross-env NODE_ENVIRONMENT=production node dist/bin/helio",webpack:"webpack",build:"cross-env NODE_ENV=production npm-run-all webpack build:mods","build:mods":"babel src/mods --out-dir dist/mods","version:patch":"npm version patch","version:minor":"npm version minor","version:major":"npm version major",push:"git push && npm publish",test:"standard && cross-env NODE_ENV=testing PORT=0 mocha --require @babel/register --require dotenv/config --exit","test:mods":"npm-run-all test:mods:users test:mods:blog","test:mods:users":"newman run -e test/postman/postman_environment.json test/postman/collections/UsersMod.json","test:mods:blog":"newman run -e test/postman/postman_environment.json test/postman/collections/BlogMod.json","test:mods:staging":"npm-run-all test:mods:staging:users test:mods:staging:blog","test:mods:staging:users":"newman run -e test/postman/postman_environment_staging.json test/postman/collections/UsersMod.json","test:mods:staging:blog":"newman run -e test/postman/postman_environment_staging.json test/postman/collections/BlogMod.json","test:mods:prod":"npm-run-all test:mods:prod:users test:mods:prod:blog","test:mods:prod:users":"newman run -e test/postman/postman_environment_prod.json test/postman/collections/UsersMod.json","test:mods:prod:blog":"newman run -e test/postman/postman_environment_prod.json test/postman/collections/BlogMod.json",commit:"commit-wizard","snyk-protect":"snyk protect",prepublish:"npm run snyk-protect"},repository:{type:"git",url:"git+https://github.com/mathiscode/helio-api-boilerplate.git"},bugs:{url:"https://github.com/mathiscode/helio-api-boilerplate/issues"},engines:{node:">=11.6.0"},standard:{ignore:["/dist"]},dependencies:{"@babel/polyfill":"^7.4.4",bcryptjs:"^2.4.3","body-parser":"^1.19.0",commander:"^2.20.0","cross-env":"^5.2.0",dotenv:"^8.0.0",express:"^4.16.4","express-jwt":"^5.3.1","express-rate-limit":"^4.0.1",figlet:"^1.2.4","helio-mod-jokes":"^1.0.0","helio-mod-users":"^1.1.1",jsonwebtoken:"^8.5.1",mongoose:"^5.5.4","npm-run-all":"^4.1.5",snyk:"^1.231.0",uuid:"^3.3.2",winston:"^3.2.1","winston-console-format":"^1.0.5","winston-mongodb":"^5.0.0"},devDependencies:{"@babel/cli":"^7.4.4","@babel/core":"^7.4.4","@babel/node":"^7.2.2","@babel/preset-env":"^7.4.4","@babel/register":"^7.4.4","babel-loader":"^8.0.6",chai:"^4.2.0","chai-http":"^4.3.0","clean-webpack-plugin":"^2.0.2",concurrently:"^4.1.2","copy-webpack-plugin":"^5.0.3","create-file-webpack":"^1.0.2",eslint:"^5.16.0","eslint-config-standard":"^12.0.0","eslint-plugin-import":"^2.17.2","eslint-plugin-node":"^9.1.0","eslint-plugin-promise":"^4.1.1","eslint-plugin-standard":"^4.0.0",mocha:"^6.1.4",newman:"^4.5.0",nodemon:"^1.18.11","pre-git":"^3.17.1",standard:"^12.0.1",webpack:"^4.32.2","webpack-cli":"^3.3.2","webpack-node-externals":"^1.7.2"},resolutions:{"set-value":"^2.0.1","caniuse-lite":"^1.0.30000998"},release:{analyzeCommits:"simple-commit-message"},config:{"pre-git":{"pre-commit":["npm run build","npm test","git add ."]}},snyk:!0}},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("figlet")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("winston-console-format")},function(e,t){e.exports=require("express-rate-limit")},function(e,t){e.exports=require("winston-mongodb")},function(e,t){e.exports=require("uuid")},function(e,t){e.exports=require("helio-mod-users")},function(e,t){e.exports=require("helio-mod-jokes")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("@babel/polyfill")},function(e,t,n){"use strict";n.r(t);n(15);var o=n(5),r=n.n(o),s=n(6),i=n.n(s),a=n(2),u=n.n(a),c=n(7),l=n.n(c),p=n(0),d=n.n(p),m=n(3),f=n.n(m),h=n(1),b=n.n(h),g=n(8),v=n(9),y=n.n(v),w=n(10),O=n(4);function E(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var x=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=t,this.name=t.name||"Example Helio Mod";var n=this.router=u.a.Router(t.routerOptions);this.publicPaths=[t.path,new RegExp("^".concat(t.path,"/.*"))],this.needModels=["User"],this.subSchemas={User:new d.a.Schema({myData:{field1:String,field2:{type:Number,required:!0},field3:{type:Date,default:Date.now},field4:Boolean,field5:[{type:String,default:"Field5 Data"}]}})},n.get("/",this.index.bind(this)),n.get("/add/:x/:y",this.add),n.get("/test-error",this.testError);var o=this;n.use(function(e,t,n,r){return t.Log.error("[MOD ERROR] (".concat(o.name,") ").concat(e.stack)),n.status(500).json({error:e.toString()})})}var t,n,o;return t=e,(n=[{key:"receiveModels",value:function(e){var t=this;for(var n in this.models={},this.subModels={},e.forEach(function(e){t.models[e.name]=e.model}),this.subSchemas){var o=this.models[n],r=this.subSchemas[n];this.subModels[n]=o.discriminator(this.name,r)}}},{key:"index",value:function(e,t,n){var o=e.user;t.json({mod:this.name,user:o})}},{key:"add",value:function(e,t,n){var o=e.params,r=o.x,s=o.y;r=parseFloat(r),s=parseFloat(s),t.json(r+s)}},{key:"testError",value:function(e,t,n){n(new Error("Intentional Error"))}}])&&E(t.prototype,n),o&&E(t,o),e}(),_=n(11);function S(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){j(e,t,n[t])})}return e}function j(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function k(e,t,n,o,r,s,i){try{var a=e[s](i),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(o,r)}function P(e){return function(){var t=this,n=arguments;return new Promise(function(o,r){var s=e.apply(t,n);function i(e){k(s,o,r,i,a,"next",e)}function a(e){k(s,o,r,i,a,"throw",e)}i(void 0)})}}function R(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var M=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.options=t,this.name=t.name||"Helio Blog Mod";var n=this.router=u.a.Router(t.routerOptions);this.needModels=["BlogPost"],this.subSchemas={BlogPost:new d.a.Schema({owner:String,public:{type:Boolean,default:!0},title:{type:String,required:!0},excerpt:String,content:{type:String,required:!0}})},this.subSchemas.BlogPost.options.toJSON={transform:function(e,t,n){return delete t._id,delete t.__v,delete t.__t,t}},n.get("/",this.getAllMyPosts.bind(this)),n.post("/",this.addPost.bind(this)),n.get("/:id",this.getPost.bind(this)),n.patch("/:id",this.updatePost.bind(this)),n.delete("/:id",this.deletePost.bind(this));var o=this;n.use(function(e,t,n,r){return t.Log.error("[MOD ERROR] (".concat(o.name,") ").concat(e.stack)),n.status(500).json({error:e.toString()})})}var t,n,o;return t=e,(n=[{key:"receiveModels",value:function(e){var t=this;for(var n in this.models={},this.subModels={},e.forEach(function(e){t.models[e.name]=e.model}),this.subSchemas){var o=this.models[n],r=this.subSchemas[n];this.subModels[n]=o.discriminator(this.name,r)}}},{key:"getAllMyPosts",value:function(){var e=P(regeneratorRuntime.mark(function e(t,n,o){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.subModels.BlogPost.find({owner:t.user.id}).sort({createdAt:"desc"});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),o(e.t0);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(t,n,o){return e.apply(this,arguments)}}()},{key:"addPost",value:function(){var e=P(regeneratorRuntime.mark(function e(t,n,o){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=new this.subModels.BlogPost({id:Object(_.v4)(),owner:t.user.id,public:t.body.public||!0,title:t.body.title||"Untitled Blog Post",excerpt:t.body.excerpt?t.body.excerpt.substring(0,256):t.body.content.length>256?t.body.content.substring(0,256)+"...":null,content:t.body.content}),e.next=4,r.save();case 4:n.json(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),o(e.t0);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(t,n,o){return e.apply(this,arguments)}}()},{key:"getPost",value:function(){var e=P(regeneratorRuntime.mark(function e(t,n,o){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.subModels.BlogPost.findOne({id:t.params.id,$or:[{owner:t.user.id},{public:!0}]});case 3:if(r=e.sent){e.next=6;break}return e.abrupt("return",n.status(404).json({error:"Post not found"}));case 6:n.json(r),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),o(e.t0);case 12:case"end":return e.stop()}},e,this,[[0,9]])}));return function(t,n,o){return e.apply(this,arguments)}}()},{key:"updatePost",value:function(){var e=P(regeneratorRuntime.mark(function e(t,n,o){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.subModels.BlogPost.findOneAndUpdate({id:t.params.id,owner:t.user.id},S({},t.body),{new:!0});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),o(e.t0);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(t,n,o){return e.apply(this,arguments)}}()},{key:"deletePost",value:function(){var e=P(regeneratorRuntime.mark(function e(t,n,o){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.subModels.BlogPost.findOneAndRemove({id:t.params.id,owner:t.user.id});case 3:r=e.sent,n.json(r),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),o(e.t0);case 10:case"end":return e.stop()}},e,this,[[0,7]])}));return function(t,n,o){return e.apply(this,arguments)}}()}])&&R(t.prototype,n),o&&R(t,o),e}(),T=n(12),L=n.n(T),I=n(13),B=n.n(I),D=n(14),U=n.n(D),q=d.a.Schema({id:{type:String,index:!0,unique:!0},username:{type:String,index:!0,unique:!0},email:{type:String,index:!0,unique:!0},password:String,roles:[{type:String}],flags:{confirmed:{type:Boolean,default:!1}},profile:{name:String},settings:{},clientSettings:{},serverSettings:{}},{timestamps:!0});q.methods.validPassword=function(e){return U.a.compareSync(e,this.password)};var A=d.a.model("User",q),H=d.a.Schema({id:{type:String,index:!0,unique:!0}},{timestamps:!0}),N=d.a.model("BlogPost",H),C=d.a.Schema({token:{type:String,required:!0,unique:!0}},{timestamps:!0});C.index({createdAt:1},{expires:process.env.JWT_TIMEOUT||"1h"});var W=d.a.model("TokenWhitelist",C),J=[{path:"/example",module:x},{path:"/user",module:L.a},{path:"/blog",module:M},{path:"/jokes",module:B.a}],z=[{name:"User",model:A},{name:"BlogPost",model:N},{name:"TokenWhitelist",model:W}];function G(e,t,n,o,r,s,i){try{var a=e[s](i),u=a.value}catch(e){return void n(e)}a.done?t(u):Promise.resolve(u).then(o,r)}function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function V(e){return(V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Y(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function Q(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}n.d(t,"DefaultModels",function(){return X});var X=[{name:"User",model:A},{name:"BlogPost",model:N},{name:"TokenWhitelist",model:W}],$=["/"].concat(Q(process.env.PUBLIC_PATHS?process.env.PUBLIC_PATHS.split(","):[])),K=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),(t=this.options=t||{}).middleware="function"==typeof t.middleware?[t.middleware]:t.middleware,t.middleware=Array.isArray(t.middleware)?t.middleware:[],this.rootHandler=t.rootHandler||null,this.mods=t.mods||J,this.models=t.models||z,this.routes=t.routes||[];var o=this.app=u()();o.set("HELIO_DB_URI",t.dbUri||process.env.DB_URI),o.set("HELIO_JWT_SECRET",t.jwtSecret||process.env.JWT_SECRET),o.set("HELIO_JWT_TIMEOUT",t.jwtTimeout||process.env.JWT_TIMEOUT||"1h"),o.set("HELIO_LOG_TO_DB",t.logToDB||"true"===process.env.LOG_TO_DB),o.set("HELIO_CONSOLE_LOG",t.consoleLog||"true"===process.env.CONSOLE_LOG),o.set("HELIO_CONSOLE_ERRORS",t.consoleErrors||"true"===process.env.CONSOLE_ERRORS),d.a.set("debug",t.mongooseDebug||!1);var r=!1;if(o.get("HELIO_DB_URI")||(r="You must pass dbUri option or have DB_URI environment variable"),o.get("HELIO_JWT_SECRET")||(r="You must pass jwtSecret option or have JWT_SECRET environment variable"),r)throw new Error(r);var s=t.logTransports||[];o.get("HELIO_LOG_TO_DB")&&s.push(new w.MongoDB({db:o.get("HELIO_DB_URI")})),s.push(new b.a.transports.Console({format:b.a.format.combine(b.a.format.colorize({all:!0}),b.a.format.padLevels(),Object(g.consoleFormat)({showMeta:!0,metaStrip:["timestamp","service"],inspectOptions:{depth:8,colors:!0,maxArrayLength:1/0,breakLength:120,compact:1/0}})),silent:!o.get("HELIO_CONSOLE_LOG")})),this.log=b.a.createLogger({level:this.options.logLevel||process.env.LOG_LEVEL||"silly",format:b.a.format.combine(b.a.format.timestamp(),b.a.format.ms(),b.a.format.errors({stack:!0}),b.a.format.splat(),b.a.format.json()),transports:s});var a=function(){n.connectDB(),n.initializeServer()};if(this.options.hideBanner)return a();i.a.text(this.options.bannerText||"Helio",{font:this.options.bannerFont||"The Edge",horizontalLayout:"default",verticalLayout:"default"},function(e,t){e&&n.log.silly("Unable to show banner:",e),e||console.log(t),a()})}var t,n,o;return t=e,(n=[{key:"connectDB",value:function(){var e=this,t=this.app.get("HELIO_DB_URI");"object"!==V(this.options.mongooseOptions)&&(this.options.mongooseOptions={}),this.options.mongooseOptions=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){F(e,t,n[t])})}return e}({},{useNewUrlParser:!0,useFindAndModify:!1,useCreateIndex:!0,useUnifiedTopology:!0},this.options.mongooseOptions),this.db=d.a.connect(t,this.options.mongooseOptions).then(function(n){return e.log.verbose("Mongo Database:",{connected:!0,uri:t.replace(/:\w+/g,":****")})}).catch(function(t){e.log.error("Mongoose Connection Error:",t),e.log.error("Refusing to continue without usable database. Exiting."),process.exit(1)})}},{key:"initializeServer",value:function(){var e=this;this.log.silly("Server initializing",{helio:O.version});var t=this.app,n=this.options;t.disable("x-powered-by"),t.use(l.a.json()),n.trustProxy&&t.set("trust proxy",1);var o=r.a.resolve(n.staticPath||"./dist/assets");this.log.verbose("Serving static content from:",{staticPath:o}),t.use(u.a.static(o));var s=y()({windowMs:n.rateLimitWindow||process.env.RATE_LIMIT_WINDOW||9e5,max:n.rateLimitMaxRequestsPerWindow||process.env.RATE_LIMIT_MAX_REQUESTS_PER_WINDOW||100,skip:function(e,t){return"127.0.0.1"===e.ip||"::ffff:127.0.0.1"===e.ip||"::1"===e.ip||(n.rateLimitExemptUrls||["/jokes"]).includes(e.url)}});n.disableRateLimiter||t.use(s),t.use(function(t,n,o){return t.log=t.Log=e.log,e.log.verbose("Incoming request:",{url:t.url,ip:t.ip,rate:t.rateLimit||1/0}),o()}),n.middleware.forEach(function(e){return t.use(e)}),this.mods.forEach(function(e){var t=new(0,e.module)(e),n=t.publicPaths||[];$=[].concat(Q($),Q(n)),t=null});var i=function(){var e,t=(e=regeneratorRuntime.mark(function e(t,n,o){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,W.countDocuments({token:t.headers.authorization.replace("Bearer ","")});case 2:return r=e.sent,e.abrupt("return",o(null,!r));case 4:case"end":return e.stop()}},e)}),function(){var t=this,n=arguments;return new Promise(function(o,r){var s=e.apply(t,n);function i(e){G(s,o,r,i,a,"next",e)}function a(e){G(s,o,r,i,a,"throw",e)}i(void 0)})});return function(e,n,o){return t.apply(this,arguments)}}();t.use(f()({secret:t.get("HELIO_JWT_SECRET"),credentialsRequired:!1})),t.use(f()({secret:t.get("HELIO_JWT_SECRET"),isRevoked:i}).unless({path:$}));var a=[];this.mods.forEach(function(e){var n=new(0,e.module)(e);if(n.receiveModels&&n.needModels){var o=z.filter(function(e){return n.needModels.includes(e.name)});n.receiveModels(o)}t.use(e.path,n.router),a.push(n.name)}),a.length>0&&this.log.verbose("Registered Mods:",{mods:a});var c=[];this.routes.forEach(function(e){t.use(e.path,e.module),c.push(e.path)}),c.length>0&&this.log.info("Registered Core Routes:",{routes:c}),this.rootHandler||(this.options.staticPath||this.log.warn("No root handler or static path provided; using defaults."),t.use("/",function(e,t){t.json({name:n.name||process.env.NAME||"Helio API Server",version:process.env.SHOW_VERSION?O.version:null})})),t.use(function(e,t,n){return t.status(404).json({error:"Invalid API method"})}),t.use(function(t,o,r,s){return n.consoleErrors&&"UnauthorizedError"!==t.name&&e.log.error("APP ERROR:",t.stack),"UnauthorizedError"===t.name?r.status(401).json({error:"Invalid token"}):r.status(500).json({error:"Internal API error"})}),n.noListen||this.listen()}},{key:"listen",value:function(e){var t=this,n=this.options.port||process.env.PORT||3001,o=this.app.listen(n,function(){t.port=o.address().port,t.log.info("".concat(t.options.name||process.env.NAME||"Helio API Server"," listening"),o.address()),"function"==typeof e&&e(o)})}}])&&Y(t.prototype,n),o&&Y(t,o),e}();t.default=K}])});